function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Panel=function(){function Panel(Jupyter){_classCallCheck(this,Panel),this.Jupyter=Jupyter,this.menubarDropdowns={file:"#file_menu",edit:"#edit_menu",view:"#view_menu",insert:"#insert_menu",cell:"#cell_menu",kernel:"#kernel_menu",widgets:"#widget-submenu",help:"#help_menu"};this.toolbarActions={"save-notebook":'[data-jupyter-action="jupyter-notebook:save-notebook"]',"insert-cell-below":'[data-jupyter-action="jupyter-notebook:insert-cell-below"]',"cut-cell":'[data-jupyter-action="jupyter-notebook:cut-cell"]',"copy-cell":'[data-jupyter-action="jupyter-notebook:copy-cell"]',"paste-cell-below":'[data-jupyter-action="jupyter-notebook:paste-cell-below"]',"move-cell-up":'[data-jupyter-action="jupyter-notebook:move-cell-up"]',"move-cell-down":'[data-jupyter-action="jupyter-notebook:move-cell-down"]',"run-cell-and-select-next":'[data-jupyter-action="jupyter-notebook:run-cell-and-select-next"]',"interrupt-kernel":'[data-jupyter-action="jupyter-notebook:interrupt-kernel"]',"confirm-restart-kernel":'[data-jupyter-action="jupyter-notebook:confirm-restart-kernel"]',"confirm-restart-kernel-and-run-all-cells":'[data-jupyter-action="jupyter-notebook:confirm-restart-kernel-and-run-all-cells"]',"cell-type":"#cell_type","show-command-palette":'[data-jupyter-action="jupyter-notebook:show-command-palette"]'}}return _createClass(Panel,[{key:"setDisplay",value:function(selector,val){document.querySelector(selector).style.display=val}},{key:"addClass",value:function(selector,className){document.querySelector(selector).classList.add(className)}},{key:"removeClass",value:function(selector,className){document.querySelector(selector).classList.remove(className)}},{key:"hideWidgetMenu",value:function(){var _this=this,target=document.querySelector("#menus ul.navbar-nav"),observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){var widgetSubmenu=mutation.target.querySelector(_this.menubarDropdowns.widgets);widgetSubmenu&&(widgetSubmenu.parentElement.style.display="none",observer.disconnect())})}),config={attributes:!0,childList:!0,characterData:!0};observer.observe(target,config)}},{key:"showAll",value:function(){this.addClass("#header-container","show-panel"),this.addClass("#maintoolbar","show-panel"),this.addClass("#menubar-container ul.navbar-nav","show-panel")}},{key:"setup",value:function(coco){var _this2=this;if(coco)return void this.showAll();var metadata=this.Jupyter.notebook.metadata,_metadata$udacity=metadata.udacity,_metadata$udacity$hea=_metadata$udacity.header,header=void 0===_metadata$udacity$hea?{}:_metadata$udacity$hea,_metadata$udacity$too=_metadata$udacity.toolbar,toolbar=void 0===_metadata$udacity$too?{}:_metadata$udacity$too,_metadata$udacity$men=_metadata$udacity.menubar,menubar=void 0===_metadata$udacity$men?{}:_metadata$udacity$men,menubarEl=document.querySelector("#menubar");if(header.hidden||this.addClass("#header-container","show-panel"),!menubar.hidden&&(this.addClass("#menubar-container ul.navbar-nav","show-panel"),menubar.hidden_menus)){menubarEl.querySelectorAll("ul.navbar-nav > li").forEach(function(dropdownEl){menubar.hidden_menus.find(function(menu){var menuSelector=_this2.menubarDropdowns[menu];return null!=dropdownEl.querySelector(menuSelector)})&&(dropdownEl.style.display="none")}),menubar.hidden_menus.includes("widgets")&&this.hideWidgetMenu()}if(toolbar.hidden||(toolbar.hidden_actions&&toolbar.hidden_actions.forEach(function(action){var selector=_this2.toolbarActions[action];selector&&_this2.setDisplay(selector,"none")}),this.addClass("#maintoolbar","show-panel")),(toolbar.hidden||menubar.hidden)&&header.hidden&&menubarEl.classList.add("only-panel"),menubar.hidden&&!toolbar.hidden){var toolbarContainer=document.querySelector("#maintoolbar-container");document.querySelector("#menus .navbar-collapse").before(toolbarContainer),menubarEl.classList.add("only-panel"),this.addClass("#maintoolbar-container.toolbar","with-statusbar"),this.removeClass("#maintoolbar","show-panel")}}}]),Panel}();define("panel.js",function(){});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),PYNG_INTERVAL=12e4,IDLE_TIMEOUT=18e5,RETRY_ATTEMPTS=6,RETRY_INTERVAL=15e3,AUTOSAVE_INTERVAL=15e3,Pyng=function(){function Pyng(Jupyter,star){_classCallCheck(this,Pyng),this.Jupyter=Jupyter,this.star=star,this.activity=new ActivityTracker({timeout:IDLE_TIMEOUT}),this.activity.start()}return _createClass(Pyng,[{key:"start",value:function(){var _this=this;this.mainLoop().catch(function(err){console.log(err),_this.stop()}),this.Jupyter.notebook.set_autosave_interval(AUTOSAVE_INTERVAL)}},{key:"mainLoop",value:function(){var _this2=this;return console.log("Beginning pyng main loop"),new Promise(function(resolve,reject){var checkIdle=function(){if(_this2.activity.isIdle)return console.log("Notebook is idle"),_this2.stop(),resolve();retry(function(){return _this2.star.keepAlive()},RETRY_ATTEMPTS,RETRY_INTERVAL).catch(reject)};_this2.interval=setInterval(function(){return checkIdle()},PYNG_INTERVAL)})}},{key:"stop",value:function(){console.log("Stopping notebook pyng"),this.interval&&clearInterval(this.interval),this.activity&&this.activity.stop()}}]),Pyng}(),ActivityTracker=function(){function ActivityTracker(_ref){var _this3=this,timeout=_ref.timeout,_ref$element=_ref.element,element=void 0===_ref$element?document:_ref$element,_ref$events=_ref.events,events=void 0===_ref$events?["click","keydown","mousemove"]:_ref$events;_classCallCheck(this,ActivityTracker),this.lastActivity=Date.now(),this.timeout=timeout,this.events=events,this.element=element,this.updater=debounce(function(){return _this3.update()},500)}return _createClass(ActivityTracker,[{key:"update",value:function(){this.lastActivity=Date.now()}},{key:"start",value:function(){var _this4=this;return this.events.map(function(event){return _this4.element.addEventListener(event,_this4.updater)})}},{key:"stop",value:function(){var _this5=this;return this.events.map(function(event){return _this5.element.removeEventListener(event,_this5.updater)})}},{key:"isIdle",get:function(){return Date.now()-this.lastActivity>this.timeout}}]),ActivityTracker}(),sleep=function(ms){return new Promise(function(resolve){return setTimeout(resolve,ms)})},retry=function(func,count,delay){return new Promise(function(resolve,reject){!function _retry(func,count,delay,resolve,reject){func().then(resolve).catch(function(err){return count>1?sleep(delay).then(function(){return _retry(func,count-1,delay,resolve,reject)}).catch(reject):reject(err)})}(func,count,delay,resolve,reject)})},debounce=function(func,wait,immediate){var timeout=void 0;return function(){var context=this,args=arguments,later=function(){timeout=null,immediate||func.apply(context,args)},callNow=immediate&&!timeout;clearTimeout(timeout),timeout=setTimeout(later,wait),callNow&&func.apply(context,args)}};define("pyng.js",function(){});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Star=function(){function Star(Jupyter){_classCallCheck(this,Star),this.Jupyter=Jupyter,this.token=null}return _createClass(Star,[{key:"getStarUser",value:function(){var _this=this;return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("POST","https://nebula.udacity.com/api/v1/remote/me"),xhr.setRequestHeader("Authorization","Star "+_this.token),xhr.onload=function(){this.status>=200&&this.status<300?resolve(JSON.parse(xhr.response)):reject({status:this.status,statusText:xhr.statusText})},xhr.onerror=function(){reject({status:this.status,statusText:xhr.statusText})},xhr.send()})}},{key:"getToken",value:function(){var _this2=this,executeCallbackObject=function(callback){return{iopub:{output:function(data){return data.content.text?callback(data.content.text):null}}}};return new Promise(function(resolve,reject){_this2.Jupyter.notebook.kernel.execute('!curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/keep_alive_token" -H "Metadata-Flavor: Google" -s --fail',executeCallbackObject(function(output){_this2.token=output,resolve(output)}))})}},{key:"keepAlive",value:function(){var context=this;return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("POST","https://nebula.udacity.com/api/v1/remote/keep-alive"),xhr.setRequestHeader("Authorization","Star "+context.token),xhr.onload=function(){this.status>=200&&this.status<300?resolve(xhr.response):reject({status:this.status,statusText:xhr.statusText})},xhr.onerror=function(){reject({status:this.status,statusText:xhr.statusText})},xhr.send()})}}]),Star}();define("star.js",function(){}),define("nbextensions/jupyng-dist/extension",["base/js/namespace","panel.js","pyng.js","star.js"],function(Jupyter){return{load_ipython_extension:function(){var star=new Star(Jupyter),panel=new Panel(Jupyter),hasCustomConf=function(meta){return meta&&meta.udacity},initExtension=function(){star.getToken(Jupyter).then(function(){return new Pyng(Jupyter,star).start(),star.getStarUser()}).then(function(user){var coco=user&&user.coco;hasCustomConf(Jupyter.notebook.metadata)&&panel.setup(coco)}).catch(function(err){console.log(err),panel.showAll()})};Jupyter.notebook._fully_loaded&&!hasCustomConf(Jupyter.notebook.metadata)?panel.showAll():Jupyter.notebook.events.on("notebook_loaded.Notebook",function(){!hasCustomConf(Jupyter.notebook.metadata)&&panel.showAll()}),Jupyter.notebook.kernel?initExtension():Jupyter.notebook.events.one("kernel_ready.Kernel",function(){initExtension()})}}});